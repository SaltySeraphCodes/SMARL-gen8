{% extends 'overlay_base.html' %}
{% block title %}
Smarl Starting Display
{% endblock %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/stream_brand.css') }}">
<div id="lapDisplay">
</div>
    <script src="{{ url_for('static', filename='src/smarl_utils.js') }}"></script>
    <script>    
        // THis displays the starting grid based racers in racerData TWITCH INTEGRATION SPECIFIC
        // NOTE: 'WINS' COLUMN HAS BEEN REPLACED BY 'POINTS' (PTS) FOR SEASON RELEVANCE.
        // NOTE: 'Best Lap' column added for enhanced data display.

    function reloadChart(data){
        d3.select("#lapDisplay").selectAll("svg").remove();
        reloadGraphic(data);
    }

    function readStats(data){
        // Function remains unused, but kept for structure
    }

    function reloadGraphic(data){
            drawData(data);
    }
    // Global chart element vars
    // data helpers
    var yScale;
    var xScale;
    var chart_area;
    var interactive_chart;
    var chartSettings;
    
    // --- NEW: Column positioning settings for precise alignment ---
    const CHART_LEFT_MARGIN = 380; // magic number to center chart
    const CHART_RIGHT_MARGIN = 1;
    const COLUMN_GAP = 10;
    const columnSettings = {
        'Color':    { index: 0, width: 120, xStart: CHART_LEFT_MARGIN },
        'Name':     { index: 1, width: 500, xStart: CHART_LEFT_MARGIN + 120 + COLUMN_GAP },
        'Tag':      { index: 2, width: 150, xStart: CHART_LEFT_MARGIN + 120 + COLUMN_GAP + 500 + COLUMN_GAP },
        'Points':   { index: 3, width: 150, xStart: CHART_LEFT_MARGIN + 120 + COLUMN_GAP + 500 + COLUMN_GAP + 150 + COLUMN_GAP },
        'Best Lap': { index: 4, width: 200, xStart: CHART_LEFT_MARGIN + 120 + COLUMN_GAP + 500 + COLUMN_GAP + 150 + COLUMN_GAP + 150 + COLUMN_GAP }
    };
    // ------------------------------------------------------------------
    //Width of chart data
    const TOTAL_WIDTH = columnSettings['Best Lap'].xStart + columnSettings['Best Lap'].width ;
      //width of columns
    const MID_CHART = (TOTAL_WIDTH/2) + CHART_LEFT_MARGIN //Mid coord of chart
    console.log((1920-TOTAL_WIDTH)/2)
    // Visible elements
    var racerBG; // The background squares that contain the data
    var posRects;
    var all_elements = []
    var twitch_stats = {}; // All twitch stats
    
    // --- Flag to control transition flow ---
    let initialDrawComplete = false; 

    // Define helper function for color logic (used by colRect)
    const getColorAttrs = (d) => {
        const primary = d['primary_color'];
        const tertiary = d['tertiary_color'];
        return {
            fill: (primary.charAt(0) === '#') ? primary : "#" + primary,
            stroke: (tertiary.charAt(0) === '#') ? tertiary : "#" + tertiary
        };
    };
    
    // Define helper function for secondary color (used by secondary path)
    const getSecondaryFill = (d) => {
        let color = d['secondary_color'];
        return (color.charAt(0) === '#') ? color : "#" + color;
    }

    // Define helper function for points text
    const getPointsText = (d) => {
        let userid = d['owner']
        const stats = twitch_stats[userid];
        return (d['points'] !== undefined) ? String(Math.floor(d['points'])) : ((stats && stats['points'] !== undefined) ? String(stats['points']) : "0");
    };

    // Define helper function for Best Lap text (NEW)
    const getBestLapText = (d) => {
        let userid = d['owner']
        if (twitch_stats == null){
            return "-"
        }
        const stats = twitch_stats[userid];
        if(stats == null){
            return "-"
        }
        return stats['best_lap_time'] || "-"; 
    };


    function createBoard(data) {
        boardCreated = true;
        totalCars = data.length
        carSize = 50 * totalCars
        
        var labelList = ['Color', 'Name', 'Tag', 'Points', 'Best Lap'] 
        
        // Updated chartSettings with new margin
        chartSettings = { width: 1920, height: 1080, margin: {left: CHART_LEFT_MARGIN, right:CHART_RIGHT_MARGIN, top: 100, bottom:55}}
        
        //Scales
        xScale = d3.scaleLinear()
            .domain([0,chartSettings.width])
            .range([chartSettings.margin.left,chartSettings.width - chartSettings.margin.right]);

        // labelScale is no longer needed but was removed in previous steps, confirming its absence.

        yScale = d3.scaleLinear()
            .domain([0,totalCars +1])// Total cars racing
            .range([chartSettings.margin.top + 100,chartSettings.height - chartSettings.margin.bottom]); 

        chart_area = d3.select("#lapDisplay").append("svg")
            .attr('width', chartSettings.width)
            .attr('height',chartSettings.height)
        interactive_chart = chart_area.append('g')
        
        var bgRect = interactive_chart.append('rect')
            .attr("x",chartSettings.margin.left)
            .attr('y',chartSettings.margin.top)
            .attr("rx", SMARL_SETTINGS.BORDER_RADIUS_DEFAULT || 5)
            .attr('ry', SMARL_SETTINGS.BORDER_RADIUS_DEFAULT || 5)
            .attr('width',TOTAL_WIDTH - CHART_LEFT_MARGIN)
            .attr('height',0)
            .attr('opacity',0)
            .attr('fill','var(--brand-dark)') // Background box fill
            .transition()
            .attr('height',chartSettings.height - chartSettings.margin.bottom)
            .attr("opacity",0.99)
            .duration(SMARL_SETTINGS.TRANSITION_SHORT)

        //Header
        var header = interactive_chart.append("text")
        .attr('class','headerText') // <-- USING CSS CLASS
        .attr("x", chartSettings.width/2)
        .attr("y", chartSettings.margin.top + 30 )
        .attr("opacity",0)
        .text("{{raceData.title}}")
        .attr('text-anchor', 'middle')
        .attr('alignment-baseline', 'central')
        .transition()
        .attr("opacity",1)
        .duration(SMARL_SETTINGS.TRANSITION_LONG)
        
        // SubHeader
        var SubHeader = interactive_chart.append("text")
        .attr('class','subHeaderText labelText') // <-- USING CSS CLASS
        .attr("x", chartSettings.width/2)
        .attr("y", chartSettings.margin.top + 70 )
        .attr("opacity",0)
        .text("{{raceData.location}}")
        .attr('text-anchor', 'middle')
        .attr('alignment-baseline', 'central')
        .transition()
        .attr("opacity",1)
        .duration(SMARL_SETTINGS.TRANSITION_LONG)

        // Label BGs
        labelRects = interactive_chart.selectAll(".labelRect")
        .data(labelList)

        labelRects.enter()
        .append("rect")
        .attr("class","labelRect titleEl")
        .attr("rx", 7)
        .attr("ry", 7)
        .attr("x", function(d){
            // *** REVISED X LOGIC ***
            return columnSettings[d].xStart;
        })
        .attr("y", chartSettings.margin.top-20)
        .attr("width",function(d){
            // *** REVISED WIDTH LOGIC ***
            return columnSettings[d].width;
        })
        .attr("height",40)
        .attr("fill",'var(--brand-main)') 
        .attr('stroke','var(--brand-text)') 
        .attr("opacity",0)
        .transition()
        .attr("y", chartSettings.margin.top +90)
        .attr("opacity",1)
        .duration(SMARL_SETTINGS.TRANSITION_LONGER)
        
        labelRects.transition()
        .duration(SMARL_SETTINGS.TRANSITION_LONGER)
    
        
        labelRects.exit()
        .transition()
        .attr("y",yScale(-100))
        .attr("opacity",0)
        .duration(SMARL_SETTINGS.TRANSITION_LONGER)
        .remove()

        // Title labels
        var labels= interactive_chart.selectAll(".labelText.column-title")
        .data(labelList)


        labels.enter()
        .append('text')
        .attr('class', 'labelText column-title')
        .attr("x", function(d){
            // *** REVISED X POSITION (Start + Half Width) ***
            const settings = columnSettings[d];
            return settings.xStart + (settings.width / 2);
        })
        .attr("y",chartSettings.margin.top-20)
        .attr('text-anchor', 'middle')
        .attr('alignment-baseline', 'central')
        .attr("opacity",0)
        .text(function(d){
            return d
        })
        .attr('fill','var(--brand-text)') 
        .transition()
        .attr("y", chartSettings.margin.top + 110) 
        .attr("opacity",1)
        .duration(SMARL_SETTINGS.TRANSITION_LONGER)

        // Separator line

        var sepLine = interactive_chart.append("line")
        .attr("x1", columnSettings['Color'].xStart) // Start at Color column
        .attr("y1", chartSettings.margin.top +135)
        .attr("x2", TOTAL_WIDTH)
        .attr("y2", chartSettings.margin.top +135)
        .attr('stroke-width',3)
        .attr("stroke",'var(--brand-main)') 
        .transition()
        .attr("opacity",1)
        .duration(SMARL_SETTINGS.TRANSITION_LONG)
        drawData(data)
    }
    
    // START: REVISED drawData FUNCTION
    function drawData(data){
        totalCars = data.length
        yScale.domain([0,totalCars +1])
              .range([chartSettings.margin.top + 100,chartSettings.height - chartSettings.margin.bottom]);
        
        // Calculate the full width of the table
        const tableStart = columnSettings['Color'].xStart;
        const tableEnd = columnSettings['Best Lap'].xStart + columnSettings['Best Lap'].width;
        const tableWidth = tableEnd - tableStart;

        // ----------------- Racer Background Rects -----------------
        racerBG = interactive_chart.selectAll(".bgRect.racerData")
        .data(data, function(d) { return d.uid; }) 
        
        // 1. EXIT Selection
        racerBG.exit()
        .transition()
        .attr("x",xScale(3000))
        .attr("opacity",0)
        .duration(SMARL_SETTINGS.TRANSITION_LONGER)
        .remove();

        // 2. ENTER Selection (Defines start position and starts the long entry transition)
        const racerBGEnter = racerBG.enter()
        .append("rect")
        .attr("class","bgRect racerData racerEl")
        .attr('rx',3)
        .attr('ry',3)
        .attr("width",tableWidth) // Uses calculated width
        .attr("height",50)
        .attr("x",tableStart) 
        .attr("y",function (d,i){
            return yScale(i + 1) + 300 // Start position (off-screen for animation)
        })
        .attr("opacity",0);
        
        // Apply the entry transition to NEW elements only
        racerBGEnter.transition()
            .duration(SMARL_SETTINGS.TRANSITION_LONGER)
            .attr("x",tableStart)
            .attr("y",function (d,i){
                return yScale(i + 1)
            })
            .attr("opacity",0.85);

        // 3. MERGE Selection 
        const racerBGMerge = racerBGEnter.merge(racerBG)
        .attr("fill", (d, i) => i % 2 === 0 ? 'var(--brand-dark-transparent)' : 'var(--brand-dark)')
        .transition().duration(SMARL_SETTINGS.TRANSITION_SHORT)
            .attr("x",tableStart)
            .attr("y",function (d,i){
                return yScale(i + 1)
            })
            .attr("opacity",0.85);

        all_elements.push(racerBGMerge)

        // ----------------- Racer name text -----------------
        const nameCol = columnSettings['Name'];
        nameText = interactive_chart.selectAll(".nameText")
        .data(data, function(d) { return d.uid; }) 

        // 1. EXIT Selection
        nameText.exit()
        .transition()
        .attr("x",xScale(230) )
        .attr("opacity",0)
        .duration(SMARL_SETTINGS.TRANSITION_LONG)
        .remove();

        // 2. ENTER Selection
        const nameTextEnter = nameText.enter()
        .append('text')
        .attr('class','nameText racerEl labelText')
        .attr('dx',"0em") 
        //.attr('font-family',"var(--brand-font-primary)")
        //.attr('font-size','24px')
        //.attr('fill','var(--brand-text)')
        .attr('text-anchor', 'middle') 
        .attr('alignment-baseline', 'central') 
        .attr("x", xScale(1900))
        .attr('y',function(d,i){ return yScale(i + 1) + 25; }) 
        .attr("opacity",0)
        .text(function(d){ return d['name']});
        
        // Apply the entry transition to NEW elements only
        nameTextEnter.transition()
            .duration(SMARL_SETTINGS.TRANSITION_LONGER)
            .delay(1000)
            .attr("x", nameCol.xStart + (nameCol.width / 2)) // Centered
            .attr('y',function(d,i){
                return yScale(i + 1) + 25
            }) 
            .attr("opacity",1);

        // 3. MERGE Selection 
        const nameTextMerge = nameTextEnter.merge(nameText)
        .text(function(d){ return d['name']})
        .transition().duration(SMARL_SETTINGS.TRANSITION_SHORT)
            .attr("x", nameCol.xStart + (nameCol.width / 2))
            .attr('y',function(d,i){
                return yScale(i + 1) + 25
            }) 
            .attr("opacity",1);
        
        all_elements.push(nameTextMerge)
        
        // ----------------- Racer Primary color rect -----------------
        const colorCol = columnSettings['Color'];
        colRect = interactive_chart.selectAll(".colRect")
        .data(data, function(d) { return d.uid; }) 

        // 1. EXIT Selection
        colRect.exit()
        .transition()
        .attr("x",xScale(1900))
        .attr("opacity",0)
        .duration(SMARL_SETTINGS.TRANSITION_LONG)
        .remove();

        // 2. ENTER Selection
        const colRectEnter = colRect.enter()
        .append('rect')
        .attr("class","colRect racerEl")
        .attr("width",100)
        .attr("height",30)
        .attr('stroke-width',2)
        .attr("fill", d => getColorAttrs(d).fill)
        .attr('stroke', d => getColorAttrs(d).stroke)
        .attr("x", colorCol.xStart + 10) // Small offset within column
        .attr('y',function(d,i){
            return yScale(i + 1) + 100
        })
        .attr("opacity",0);
        
        // Apply the entry transition to NEW elements only
        colRectEnter.transition()
            .duration(SMARL_SETTINGS.TRANSITION_LONGER)
            .delay(1000)
            .attr("x", colorCol.xStart + 10) 
            .attr('y',function(d,i){
                return yScale(i + 1) + 10
            }) 
            .attr("opacity",1);

        // 3. MERGE Selection 
        const colRectMerge = colRectEnter.merge(colRect)
        .attr("fill", d => getColorAttrs(d).fill)
        .attr('stroke', d => getColorAttrs(d).stroke)
        .transition().duration(SMARL_SETTINGS.TRANSITION_SHORT) 
            .attr("x", colorCol.xStart + 10)
            .attr('y',function(d,i){
                return yScale(i + 1) + 10
            }) 
            .attr("opacity",1); 

        all_elements.push(colRectMerge)

        // ----------------- Racer secondary color path -----------------
        var lineGenerator = d3.line()
                    // Adjust X: relative to the starting position of the color column
                    .x(function(d) { return columnSettings['Color'].xStart + d[0] + 50 }) 
                    .y(function(d) { return d[1] });
        
        function triangleGenerator(posY,width,height){
            return [ [0,posY], [width,posY], [width,posY + height]]
        }
        
        secondary = interactive_chart.selectAll(".secondary")
        .data(data, function(d) { return d.uid; }) 

        // 1. EXIT Selection
        secondary.exit()
        .transition()
        .attr("x",xScale(1900))
        .attr("opacity",0)
        .duration(SMARL_SETTINGS.TRANSITION_LONG)
        .remove();

        // 2. ENTER Selection
        const secondaryEnter = secondary.enter()
        .append("path")
        .attr("class","secondary racerEl")
        .attr('stroke','var(--brand-dark)') 
        .attr('stroke-width',1)
        .attr("opacity",0)
        .attr("fill", getSecondaryFill)
        .attr("d", function(d,i) {
            // Initial position (off-screen or retracted)
            var triangleP = triangleGenerator(yScale(i + 1) + 100,60,30)
              return lineGenerator(triangleP);
        });
        
        // Apply the entry transition to NEW elements only
        secondaryEnter.transition()
            .duration(SMARL_SETTINGS.TRANSITION_LONGER)
            .delay(1000)
            .attr("d", function(d,i) {
                // Final position
                var triangleP = triangleGenerator(yScale(i + 1) + 10,60,30)
                return lineGenerator(triangleP);
            })
            .attr("opacity",1);

        // 3. MERGE Selection 
        const secondaryMerge = secondaryEnter.merge(secondary)
        .attr("fill", getSecondaryFill)
        .transition().duration(SMARL_SETTINGS.TRANSITION_SHORT)
            .attr("d", function(d,i) {
                var triangleP = triangleGenerator(yScale(i + 1) + 10,60,30)
                return lineGenerator(triangleP);
            })
            .attr("opacity",1);

        all_elements.push(secondaryMerge)
        
        // ----------------- Racer Tag (4 letter tag) -----------------
        const tagCol = columnSettings['Tag'];
        tagText = interactive_chart.selectAll(".tagText")
        .data(data, function(d) { return d.uid; }) 
        
        // 1. EXIT Selection
        tagText.exit()
        .transition()
        .attr("x", xScale(2000))
        .attr("opacity",0)
        .duration(SMARL_SETTINGS.TRANSITION_LONG)
        .remove();

        // 2. ENTER Selection
        const tagTextEnter = tagText.enter()
        .append('text')
        .attr('class','tagText racerEl')
        .attr('id','tagText')
        .attr('dx',"0em")
        .attr('font-family',"var(--brand-font-primary)")
        .attr('font-size','22px')
        .attr('fill','var(--brand-text)')
        .attr('text-anchor', 'middle')
        .attr('alignment-baseline', 'central')
        .attr("x", xScale(2000))
        .attr('y',function(d,i){ return yScale(i + 1) + 25; })
        .attr("opacity",0)
        .text(function(d){ return d['tag']});
        
        // Apply the entry transition to NEW elements only
        tagTextEnter.transition()
            .duration(SMARL_SETTINGS.TRANSITION_LONGER)
            .delay(500)
            .attr("x", tagCol.xStart + (tagCol.width / 2)) // Centered
            .attr('y',function(d,i){
                return yScale(i + 1) + 25
            }) 
            .attr("opacity",1);

        // 3. MERGE Selection 
        const tagTextMerge = tagTextEnter.merge(tagText)
        .text(function(d){ return d['tag']})
        .transition().duration(SMARL_SETTINGS.TRANSITION_SHORT)
            .attr("x", tagCol.xStart + (tagCol.width / 2))
            .attr('y',function(d,i){
                return yScale(i + 1) + 25
            }) 
            .attr("opacity",1);
        
        all_elements.push(tagTextMerge);
        
        // ----------------- Points Text -----------------
        const ptsCol = columnSettings['Points'];
        ptsText = interactive_chart.selectAll(".ptsText")
        .data(data, function(d) { return d.uid; }) 

        // 1. EXIT Selection
        ptsText.exit()
        .transition()
        .attr("x", xScale(2000))
        .attr("opacity",0)
        .duration(SMARL_SETTINGS.TRANSITION_LONG)
        .remove();

        // 2. ENTER Selection
        const ptsTextEnter = ptsText.enter()
        .append('text')
        .attr('class','ptsText racerEl')
        .attr('dx',"0em")
        .attr('font-family',"var(--brand-font-primary)")
        .attr('font-size','23px')
        .attr('fill','var(--brand-text)')
        .attr('text-anchor', 'middle')
        .attr('alignment-baseline', 'central')
        .attr("x", xScale(2000))
        .attr('y',function(d,i){ return yScale(i + 1) + 25; })
        .attr("opacity",0)
        .text(getPointsText);
        
        // Apply the entry transition to NEW elements only
        ptsTextEnter.transition()
            .duration(SMARL_SETTINGS.TRANSITION_LONGER)
            .delay(1000)
            .attr("x", ptsCol.xStart + (ptsCol.width / 2)) // Centered
            .attr('y',function(d,i){
                return yScale(i + 1) + 25
            }) 
            .attr("opacity",1);

        // 3. MERGE Selection 
        const ptsTextMerge = ptsTextEnter.merge(ptsText)
        .text(getPointsText)
        .transition().duration(SMARL_SETTINGS.TRANSITION_SHORT)
            .attr("x", ptsCol.xStart + (ptsCol.width / 2))
            .attr('y',function(d,i){
                return yScale(i + 1) + 25
            }) 
            .attr("opacity",1);

        all_elements.push(ptsTextMerge);
        
        // ----------------- Best Lap Text (NEW) -----------------
        const bestLapCol = columnSettings['Best Lap'];
        bestLapText = interactive_chart.selectAll(".bestLapText")
        .data(data, function(d) { return d.uid; }) 

        // 1. EXIT Selection
        bestLapText.exit()
        .transition()
        .attr("x", xScale(2000))
        .attr("opacity",0)
        .duration(SMARL_SETTINGS.TRANSITION_LONG)
        .remove();

        // 2. ENTER Selection
        const bestLapTextEnter = bestLapText.enter()
        .append('text')
        .attr('class','bestLapText racerEl')
        .attr('dx',"0em")
        .attr('font-family',"var(--brand-font-primary)")
        .attr('font-size','23px')
        .attr('fill','var(--brand-text)')
        .attr('text-anchor', 'middle')
        .attr('alignment-baseline', 'central')
        .attr("x", xScale(2000))
        .attr('y',function(d,i){ return yScale(i + 1) + 25; })
        .attr("opacity",0)
        .text(getBestLapText);
        
        // Apply the entry transition to NEW elements only
        bestLapTextEnter.transition()
            .duration(SMARL_SETTINGS.TRANSITION_LONGER)
            .delay(1000)
            .attr("x", bestLapCol.xStart + (bestLapCol.width / 2)) // Centered
            .attr('y',function(d,i){
                return yScale(i + 1) + 25
            }) 
            .attr("opacity",1);

        // 3. MERGE Selection 
        const bestLapTextMerge = bestLapTextEnter.merge(bestLapText)
        .text(getBestLapText)
        .transition().duration(SMARL_SETTINGS.TRANSITION_SHORT)
            .attr("x", bestLapCol.xStart + (bestLapCol.width / 2))
            .attr('y',function(d,i){
                return yScale(i + 1) + 25
            }) 
            .attr("opacity",1);

        all_elements.push(bestLapTextMerge);
    }
    // END: REVISED drawData FUNCTION

    </script>
    <script> 
        // loads,parses, and calls all chart creation
        var boardCreated = false;  
        var smarl_data  = [] 
     // SOCKET FUNCTIONS
        var socket = io.connect('http://' + document.domain + ':' + location.port); 
        socket.on('connect', function() { 
            socket.emit( 'getTwitchStats', {
            data: 'getStats'
          }) })
          
        socket.on('raceData', function( data ) {
            smarl_data = data['realtime_data']
            if (smarl_data == null){
                console.log("No race data");
                return
            }
            let filtered_data = setupData(smarl_data)

            // --- REVISED SOCKET HANDLER LOGIC FOR TRANSITION SAFETY ---
            if (filtered_data.length > 0 && !boardCreated){
                initialize(filtered_data)
                // Set a timeout to mark the end of the entry animation period
                setTimeout(() => {
                    initialDrawComplete = true;
                }, SMARL_SETTINGS.TRANSITION_LONGER + 1500); // Increased buffer to 1500ms for safety
            } else {
                if (boardCreated){
                    if (initialDrawComplete) {
                        updateGraphic(filtered_data)
                    } 
                }
            }
            // --- END REVISED SOCKET HANDLER LOGIC ---
        })

        function setupData(data){
            // 1. Convert Object to Array (and add UID as a property)
            if (data == null){
                console.log("Data Missing?",data);
                return 
            }
            let racerArray = Object.keys(data).map(uid => ({
                uid: uid,
                ...data[uid]
            }));
            racerArray = racerArray.filter(function(d,i){return (Number(d.pos) <= 16 && Number(d.pos) != 0)} )
            racerArray.sort((a, b) => {
                                 if (b.id !== a.id) {
                                     return a.id - b.id; 
                                 }
                                 return a.uid - b.uid;
                            });
            return racerArray
        }
        
        socket.on('twitchStats', function( data ) {
            let data2 = JSON.parse(data)
            twitch_stats = data2;
        })

        function initialize(data){
            createBoard(data);
        }
        function updateGraphic(data){
            reloadGraphic(data);
        }
        
    </script>

{% endblock %}