{% extends 'overlay_base.html' %}
{% block title %}
Smarl Starting Display
{% endblock %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/stream_brand.css') }}">
<div id="lapDisplay">
</div>
    <script src="{{ url_for('static', filename='src/smarl_utils.js') }}"></script>
    <script>    
        // THis displays the starting grid based racers in racerData TWITCH INTEGRATION SPECIFIC
        // NOTE: 'WINS' COLUMN HAS BEEN REPLACED BY 'POINTS' (PTS) FOR SEASON RELEVANCE.

    function reloadChart(data){
        d3.select("#lapDisplay").selectAll("svg").remove();
        reloadGraphic(data);
    }

    function readStats(data){
        // This function is currently unused in this context, but kept for structure
    }

    function reloadGraphic(data){
            drawData(data);
    }
    // Global chart element vars
    var yScale;
    var labelScale;
    var xScale;
    var chart_area;
    var interactive_chart;
    var chartSettings;
    var racerBG; 
    var posRects;
    var all_elements = []
    var twitch_stats = {}; // All twitch stats
    
    // --- NEW: Flag to control transition flow ---
    let initialDrawComplete = false; 


    // Define helper function for color logic (used by colRect)
    const getColorAttrs = (d) => {
        const primary = d['primary_color'];
        const tertiary = d['tertiary_color'];
        return {
            fill: (primary.charAt(0) === '#') ? primary : "#" + primary,
            stroke: (tertiary.charAt(0) === '#') ? tertiary : "#" + tertiary
        };
    };
    
    // Define helper function for secondary color (used by secondary path)
    const getSecondaryFill = (d) => {
        let color = d['secondary_color'];
        return (color.charAt(0) === '#') ? color : "#" + color;
    }

    // Define helper function for points text (replaces wins)
    const getPointsText = (d) => {
        // Assuming points are directly available in the racer data 'd.points'
        // If not, this must be updated to pull from twitch_stats or a different source.
        return (d['points'] !== undefined) ? String(Math.floor(d['points'])) : "0";
    };


    function createBoard(data) {
        boardCreated = true;    
        totalCars = data.length
        carSize = 50 * totalCars
        // UPDATED LABELS: 'Wins' replaced with 'Points'
        var labelList = ['Color', 'Name', 'Tag', 'Points'] 
        
        // Updated chartSettings to assume the whole canvas is being used for this intro screen.
        chartSettings = { width: 1920, height: 1080, margin: {left: 300, right:600, top: 0, bottom:45}}
        //Scales
        xScale = d3.scaleLinear()
            .domain([0,chartSettings.width])
            .range([chartSettings.margin.left,chartSettings.width - chartSettings.margin.right]);
        labelScale=d3.scaleLinear()
            .domain([0,labelList.length-1])
            .range([chartSettings.margin.left,chartSettings.width - chartSettings.margin.right]);

        yScale = d3.scaleLinear()
            .domain([0,totalCars +1])
            .range([chartSettings.margin.top + 100,chartSettings.height - chartSettings.margin.bottom]); 

        chart_area = d3.select("#lapDisplay").append("svg")
            .attr('width', chartSettings.width)
            .attr('height',chartSettings.height)
        interactive_chart = chart_area.append('g')
        
        // Background Rect
        var bgRect = interactive_chart.append('rect')
        .attr("x",chartSettings.margin.left)
        .attr('y',chartSettings.margin.top)
        .attr("rx", SMARL_SETTINGS.BORDER_RADIUS_DEFAULT || 5)
        .attr('ry', SMARL_SETTINGS.BORDER_RADIUS_DEFAULT || 5)
        .attr('width',chartSettings.width - chartSettings.margin.right)
        .attr('height',0)
        .attr('opacity',0)
        .attr('fill','var(--brand-dark)') 
        .transition()
        .attr('height',chartSettings.height - chartSettings.margin.bottom)
        .attr("opacity",0.99)
        .duration(SMARL_SETTINGS.TRANSITION_SHORT)


        var imageSize = 230
        var smarlLogo = interactive_chart.append('image')
        .attr('xlink:href', "{{url_for('static', filename='images/SMARLLOGO3.png')}}")
        .attr('x',xScale(0))
        .attr('y',22 + chartSettings.margin.top - imageSize/2)
        .attr('opacity',0)
        .attr('width', imageSize)
        .attr('height', imageSize + 50)
        .transition()
        .delay(1000)
        .attr('opacity',1)
        .duration(900)

        //Header
        var header = interactive_chart.append("text")
        .attr('class','headerText') 
        .attr("x", chartSettings.width/2)
        .attr("y", chartSettings.margin.top + 30 )
        .attr("opacity",0)
        .text("{{raceData.title}}")
        .attr('text-anchor', 'middle')
        .attr('alignment-baseline', 'central')
        .transition()
        .attr("opacity",1)
        .duration(SMARL_SETTINGS.TRANSITION_LONG)
        
        // SubHeader
        var SubHeader = interactive_chart.append("text")
        .attr('class','subHeaderText labelText') 
        .attr("x", chartSettings.width/2)
        .attr("y", chartSettings.margin.top + 70 )
        .attr("opacity",0)
        .text("{{raceData.location}}")
        .attr('text-anchor', 'middle')
        .attr('alignment-baseline', 'central')
        .transition()
        .attr("opacity",1)
        .duration(SMARL_SETTINGS.TRANSITION_LONG)

        // Label BGs (Headers)
        labelRects = interactive_chart.selectAll(".labelRect")
        .data(labelList)

        labelRects.enter()
        .append("rect")
        .attr("class","labelRect titleEl")
        .attr("rx", 7)
        .attr("ry", 7)
        .attr("x", function(d,i){
            return labelScale(i) + 3
        })
        .attr("y", chartSettings.margin.top-20)
        .attr("width",function(d,i){
            if (d === 'Color') return 120;
            if (d === 'Tag' || d === 'Points') return 150; // Points is 150px wide
            return 300; // Default width for name
        })
        .attr("height",40)
        .attr("fill",'var(--brand-main)') 
        .attr('stroke','var(--brand-text)') 
        .attr("opacity",0)
        .transition()
        .attr("y", chartSettings.margin.top +90)
        .attr("opacity",1)
        .duration(SMARL_SETTINGS.TRANSITION_LONGER)
        
        labelRects.transition()
        .duration(SMARL_SETTINGS.TRANSITION_LONGER)
    
        
        labelRects.exit()
        .transition()
        .attr("y",yScale(-100))
        .attr("opacity",0)
        .duration(SMARL_SETTINGS.TRANSITION_LONGER)
        .remove()

        // Title labels (Text on Headers)
        var labels= interactive_chart.selectAll(".labelText.column-title")
        .data(labelList)

        labels.enter()
        .append('text')
        .attr('class', 'labelText column-title')
        .attr("x", function(d,i){
            let rectWidth = 0;
            if (d === 'Color') rectWidth = 120;
            else if (d === 'Tag' || d === 'Points') rectWidth = 150;
            else rectWidth = 300; 
            
            return labelScale(i) + 3 + (rectWidth / 2);
        })

        .attr("y",chartSettings.margin.top-20)
        .attr('text-anchor', 'middle')
        .attr('alignment-baseline', 'central')
        .attr("opacity",0)
        .text(function(d,i){
            return d
        })
        .attr('font-size','20px')
        .attr('font-weight',"bold")
        .attr('fill','var(--brand-dark)') 
        .transition()
        .attr("y", chartSettings.margin.top + 110) 
        .attr("opacity",1)
        .duration(SMARL_SETTINGS.TRANSITION_LONGER)

        // Separator line
        var sepLine = interactive_chart.append("line")
        .attr("x1", chartSettings.margin.left)
        .attr("y1", chartSettings.margin.top +135)
        .attr("x2",chartSettings.width - chartSettings.margin.left)
        .attr("y2", chartSettings.margin.top +135)
        .attr('stroke-width',3)
        .attr("stroke",'var(--brand-main)') 
        .transition()
        .attr("opacity",1)
        .duration(SMARL_SETTINGS.TRANSITION_LONG)
        drawData(data)
    }

    function drawData(data){
        totalCars = data.length
        yScale.domain([0,totalCars +1])
              .range([chartSettings.margin.top + 100,chartSettings.height - chartSettings.margin.bottom]); 
    
        // Bckground rects
        racerBG = interactive_chart.selectAll(".bgRect.racerData")
        .data(data, function(d) { return d.uid; }) 
        
        // --- 1. EXIT Selection ---
        racerBG.exit()
        .transition()
        .attr("x",xScale(3000))
        .attr("opacity",0)
        .duration(SMARL_SETTINGS.TRANSITION_LONGER)
        .remove();

        // --- 2. ENTER Selection ---
        const racerBGEnter = racerBG.enter()
        .append("rect")
        .attr("class","bgRect racerData racerEl")
        .attr('rx',3)
        .attr('ry',3)
        .attr("width",chartSettings.width- chartSettings.margin.right - 13)
        .attr("height",50)
        .attr("x",xScale(10))
        .attr("y",function (d,i){
            return yScale(i + 1) + 300 // Start position (off-screen for animation)
        })
        .attr("opacity",0);
        
        // --- ENTER Transition: Only New Elements Transition In (LONG) ---
        racerBGEnter
        .transition()
        .duration(SMARL_SETTINGS.TRANSITION_SHORT)
        .attr("x",xScale(10))
        .attr("y",function (d,i){
            return yScale(i + 1)
        })
        .attr("opacity",0.85);

        // --- 3. MERGE Selection (ONLY UPDATES STATIC PROPERTIES - NO TRANSITION) ---
        racerBGEnter.merge(racerBG)
        .attr("fill", (d, i) => i % 2 === 0 ? 'var(--brand-dark-transparent)' : 'var(--brand-dark)')
        .attr("x",xScale(10))
        .attr("y",function (d,i){
            return yScale(i + 1)
        })
        .attr("opacity",0.85);

        all_elements.push(racerBGEnter.merge(racerBG))


        // Racer name text
        nameText = interactive_chart.selectAll(".nameText")
        .data(data, function(d) { return d.uid; }) 

        // --- 1. EXIT Selection ---
        nameText.exit()
        .transition()
        .attr("x",xScale(230) )
        .attr("opacity",0)
        .duration(SMARL_SETTINGS.TRANSITION_LONG)
        .remove();

        // --- 2. ENTER Selection ---
        const nameTextEnter = nameText.enter()
        .append('text')
        .attr('class','nameText racerEl')
        .attr('dx',"0em") 
        .attr('dy',".65em")
        .attr('font-family',"var(--brand-font-primary)")
        .attr('font-size','20px')
        .attr('fill','var(--brand-text)')
        .attr('text-anchor', 'middle') 
        .attr('alignment-baseline', 'central') 
        .attr("x", xScale(1900)) 
        .attr('y',function(d,i){ return yScale(i + 1) + 25; })
        .attr("opacity",0);
        
        // --- ENTER Transition: Only New Elements Transition In (LONG) ---
        nameTextEnter
        .text(function(d){ return d['name']})
        .transition()
        .duration(SMARL_SETTINGS.TRANSITION_LONGER)
        .delay(1000)
        .attr("x",labelScale(1) + 150)
        .attr('y',function(d,i){
            return yScale(i + 1) + 25
        }) 
        .attr("opacity",1);


        // --- 3. MERGE Selection (NO TRANSITION) ---
        nameTextEnter.merge(nameText)
        .text(function(d){ return d['name']})
        .attr("x",labelScale(1) + 150)
        .attr('y',function(d,i){
            return yScale(i + 1) + 25
        }) 
        .attr("opacity",1);
        
        all_elements.push(nameTextEnter.merge(nameText))
        
        
        //Racer Primary color - small rect
        colRect = interactive_chart.selectAll(".colRect")
        .data(data, function(d) { return d.uid; }) 

        // --- 1. EXIT Selection ---
        colRect.exit()
        .transition()
        .attr("x",xScale(1900))
        .attr("opacity",0)
        .duration(SMARL_SETTINGS.TRANSITION_LONG)
        .remove();

        // --- 2. ENTER Selection ---
        const colRectEnter = colRect.enter()
        .append('rect')
        .attr("class","colRect racerEl")
        .attr("width",100)
        .attr("height",30)
        .attr('stroke-width',2)
        .attr("fill", d => getColorAttrs(d).fill)
        .attr('stroke', d => getColorAttrs(d).stroke)
        .attr("x",labelScale(0)+ 20)
        .attr('y',function(d,i){
            return yScale(i + 1) + 100
        })
        .attr("opacity",0);

        // --- ENTER Transition: Only New Elements Transition In (LONG) ---
        colRectEnter
        .transition()
        .duration(SMARL_SETTINGS.TRANSITION_LONGER)
        .delay(1000)
        .attr("x",labelScale(0) + 20)
        .attr('y',function(d,i){
            return yScale(i + 1) + 10
        }) 
        .attr("opacity",1);  

        // --- 3. MERGE Selection (NO TRANSITION) ---
        colRectEnter.merge(colRect)
        .attr("fill", d => getColorAttrs(d).fill)
        .attr('stroke', d => getColorAttrs(d).stroke)
        .attr("x",labelScale(0) + 20)
        .attr('y',function(d,i){
            return yScale(i + 1) + 10
        }) 
        .attr("opacity",1); 

        all_elements.push(colRectEnter.merge(colRect))

        //Racer secondary color - small triangle/corner
        var lineGenerator = d3.line()
                    .x(function(d) { return xScale(d[0]) + 90 })
                    .y(function(d) { return d[1] });
        
        function triangleGenerator(posY,width,height){
            return [ [0,posY], [width,posY], [width,posY + height]]
        }
        
        secondary = interactive_chart.selectAll(".secondary")
        .data(data, function(d) { return d.uid; }) 

        // --- 1. EXIT Selection ---
        secondary.exit()
        .transition()
        .attr("x",xScale(1900))
        .attr("opacity",0)
        .duration(SMARL_SETTINGS.TRANSITION_LONG)
        .remove();

        // --- 2. ENTER Selection ---
        const secondaryEnter = secondary.enter()
        .append("path")
        .attr("class","secondary racerEl")
        .attr('stroke','var(--brand-dark)') 
        .attr('stroke-width',1)
        .attr("opacity",0)
        .attr("fill", getSecondaryFill)
        .attr("d", function(d,i) {
            var triangleP = triangleGenerator(yScale(i + 1) + 100,60,30)
             return lineGenerator(triangleP);
        });

        // --- ENTER Transition: Only New Elements Transition In (LONG) ---
        secondaryEnter
        .transition()
        .duration(SMARL_SETTINGS.TRANSITION_LONGER)
        .delay(1000)
        .attr("d", function(d,i) {
            var triangleP = triangleGenerator(yScale(i + 1) + 10,60,30)
            return lineGenerator(triangleP);
        })
        .attr("opacity",1);

        // --- 3. MERGE Selection (NO TRANSITION) ---
        secondaryEnter.merge(secondary)
        .attr("fill", getSecondaryFill)
        .attr("d", function(d,i) {
            var triangleP = triangleGenerator(yScale(i + 1) + 10,60,30)
            return lineGenerator(triangleP);
        })
        .attr("opacity",1);

        all_elements.push(secondaryEnter.merge(secondary))


        //Racer Tag (4 letter tag)
        tagText = interactive_chart.selectAll(".tagText")
        .data(data, function(d) { return d.uid; }) 
        
        // --- 1. EXIT Selection ---
        tagText.exit()
        .transition()
        .attr("x", xScale(2000))
        .attr("opacity",0)
        .duration(SMARL_SETTINGS.TRANSITION_LONG)
        .remove();

        // --- 2. ENTER Selection ---
        const tagTextEnter = tagText.enter()
        .append('text')
        .attr('class','tagText racerEl')
        .attr('id','tagText')
        .attr('dx',"0em")
        .attr('dy',".65em")
        .attr('font-family',"var(--brand-font-primary)")
        .attr('font-size','22px')
        .attr('fill','var(--brand-text)') 
        .attr('text-anchor', 'middle')
        .attr('alignment-baseline', 'central')
        .attr("x", xScale(2000))
        .attr('y',function(d,i){ return yScale(i + 1) + 25; })
        .attr("opacity",0);

        // --- ENTER Transition: Only New Elements Transition In (LONG) ---
        tagTextEnter
        .text(function(d){ return d['tag']})
        .transition()
        .duration(SMARL_SETTINGS.TRANSITION_LONGER)
        .delay(500)
        .attr("x",labelScale(2) + 75)
        .attr('y',function(d,i){
            return yScale(i + 1) + 25
        }) 
        .attr("opacity",1);
        
        // --- 3. MERGE Selection (NO TRANSITION) ---
        tagTextEnter.merge(tagText)
        .text(function(d){ return d['tag']})
        .attr("x",labelScale(2) + 75)
        .attr('y',function(d,i){
            return yScale(i + 1) + 25
        }) 
        .attr("opacity",1);
        
        all_elements.push(tagTextEnter.merge(tagText));
        
        // Points Text (Replaced Wins)
        ptsText = interactive_chart.selectAll(".ptsText")
        .data(data, function(d) { return d.uid; }) 

        // --- 1. EXIT Selection ---
        ptsText.exit()
        .transition()
        .attr("x", xScale(2000))
        .attr("opacity",0)
        .duration(SMARL_SETTINGS.TRANSITION_LONG)
        .remove();

        // --- 2. ENTER Selection ---
        const ptsTextEnter = ptsText.enter()
        .append('text')
        .attr('class','ptsText racerEl')
        .attr('dx',"0em")
        .attr('dy',".65em")
        .attr('font-family',"var(--brand-font-primary)")
        .attr('font-size','23px')
        .attr('fill','var(--brand-text)') 
        .attr('text-anchor', 'middle')
        .attr('alignment-baseline', 'central')
        .attr("x", xScale(2000))
        .attr('y',function(d,i){ return yScale(i + 1) + 25; })
        .attr("opacity",0);

        // --- ENTER Transition: Only New Elements Transition In (LONG) ---
        ptsTextEnter
        .text(getPointsText)
        .transition()
        .duration(SMARL_SETTINGS.TRANSITION_LONGER)
        .delay(1000)
        .attr("x", labelScale(3) + 75) // Center of the 150px Points column
        .attr('y',function(d,i){
            return yScale(i + 1) + 25
        }) 
        .attr("opacity",1);

        // --- 3. MERGE Selection (NO TRANSITION) ---
        ptsTextEnter.merge(ptsText)
        .text(getPointsText)
        .attr("x", labelScale(3) + 75)
        .attr('y',function(d,i){
            return yScale(i + 1) + 25
        }) 
        .attr("opacity",1);

        all_elements.push(ptsTextEnter.merge(ptsText));

    }

    </script>
    <script> 
        // loads,parses, and calls all chart creation
        var boardCreated = false;   
        var smarl_data  = [] 

      // --- MODIFIED SOCKET HANDLER LOGIC ---
        var socket = io.connect('http://' + document.domain + ':' + location.port);
        
        socket.on('connect', function() {
            socket.emit( 'getTwitchStats', {
            data: 'getStats'
          }) 
        })
         
        socket.on('raceData', function( data ) {
            smarl_data = data['realtime_data']
            let filtered_data = setupData(smarl_data)
            
            if (filtered_data.length > 0 && !boardCreated){
                // INITIAL DRAW: Start the long entrance animations
                initialize(filtered_data)
                
                // Set a timeout to mark when the longest entrance animation should be complete.
                // Assuming TRANSITION_LONGER is the max duration (~1000ms), we add a buffer.
                // This controls when rapid updates are allowed to prevent transition reset.
                setTimeout(() => {
                    initialDrawComplete = true;
                }, SMARL_SETTINGS.TRANSITION_LONGER + 500); 

            } else if (boardCreated){
                // SUBSEQUENT UPDATES
                if (initialDrawComplete) {
                    // Only allow full D3 redraw after the long animation has finished
                    updateGraphic(filtered_data)
                } else {
                    // Do nothing during the initial transition period.
                    // This pauses the update stream to let the animation finish.
                    // Data may be slightly stale for 1.5s, but transitions will be smooth.
                }
            }
        })

        function setupData(data){
            // 1. Convert Object to Array (and add UID as a property)
            let racerArray = Object.keys(data).map(uid => ({
                uid: uid,
                ...data[uid]
            }));
            racerArray = racerArray.filter(function(d,i){return (Number(d.pos) <= 16 && Number(d.pos) != 0)} )
            racerArray.sort((a, b) => {
                            if (b.id !== a.id) {
                                return a.id - b.id; // Higher points first
                            }
                            return a.uid - b.uid; // Then higher wins
                        });
            return racerArray
        }
        
        socket.on('twitchStats', function( data ) {
            let data2 = JSON.parse(data)
            twitch_stats = data2;
        })

        function initialize(data){
            createBoard(data);
        }
        function updateGraphic(data){
            // This is the function called repeatedly once the initial animation is done
            reloadGraphic(data);
        }
        
    </script>

{% endblock %}