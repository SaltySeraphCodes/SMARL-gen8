{% extends 'overlay_base.html' %}
{% block title %}
Smarl Status Display
{% endblock %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/stream_brand.css') }}">
<div id="lapDisplay">
</div>
    <script src="{{ url_for('static', filename='src/smarl_utils.js') }}"></script>
    <script>    
    var boardCreated = false;   
    function reloadChart(){
        d3.select("#lapDisplay").selectAll("svg").remove();
        reloadGraphic();
    }

    function reloadGraphic(data){
        drawData(data);
    }
    // Global chart element vars
    var yScale;
    var xScale;
    var chart_area;
    var interactive_chart;
    var chartSettings;

    // Visible elements
    var racerBG; 

    function createBoard(data) {
        totalCars = 1 
        // Optimized for a compact display in the corner of a stream
        chartSettings = { width: 250, height: 60, margin: {left: 30, right:30, top: 20, bottom:20}} 
        chart_area = d3.select("#lapDisplay").append("svg")
            .attr('width', chartSettings.width)
            .attr('height',chartSettings.height)
        interactive_chart = chart_area.append('g')
        drawData(data)
        boardCreated = true;
    }

    function drawData(data){
        //function to determine the fill color based on status (remains unchanged)
        const getStatusColor = (d) => {
            // Checkered Flag/Finished
            if (d['lapsLeft'] === 0 || d['lapsLeft'] === -1 || d['status'] === 'Finished') {
                return 'var(--status-finished)'; // White/Light
            }
            // Caution/Yellow Flag
            if (d['status'] === 'Caution' || d['status'] === 'Red Flag') {
                return 'var(--status-caution)'; // Yellow/Accent
            }
            // Green Flag/Racing
            if (d['status'] === 'Green Flag' || d['status'] === 'Racing') {
                return 'var(--status-racing)'; // Green
            }
            // Formation/Other (Pre-race/Black Flag)
            return 'var(--status-pre-race)'; // Dark/Black/Main background color
        }
        
        // Function to determine the text color (contrast) (remains unchanged)
        const getTextColor = (d) => {
            const statusColor = getStatusColor(d);
            // If background is Finished (light color) or Caution (light color), use dark text for contrast
            if (statusColor === 'var(--status-finished)' || statusColor === 'var(--status-caution)'){
                return 'var(--brand-text-dark)' // Use the dark text var
            }
            // Otherwise use the inverted (usually light) brand text color
            return 'var(--brand-text)'
        }
        
        // --- STATUS BACKGROUND RECTANGLE ---
        racerBG = interactive_chart.selectAll(".bgRectStatus")
        // FIX: Use a fixed key to ensure D3 updates the existing element, not exit/enter
        .data(data, d => 'single_status'); 
        
        // EXIT
        racerBG.exit().transition().attr("x", chartSettings.width).attr("opacity",0).duration(SMARL_SETTINGS.TRANSITION_SHORT).remove();

        // ENTER
        const racerBGEnter = racerBG.enter()
        .append("rect")
        .attr("class","bgRectStatus racerEl")
        .attr('rx',10).attr('ry',10)
        .attr("width",chartSettings.width-10)
        .attr("height",chartSettings.height - 10)
        .attr('stroke','var(--brand-dark)')
        .attr("x",5) 
        .attr("y",5)
        .attr("opacity",0);

        // MERGE 
        racerBGEnter.merge(racerBG)
        .attr("fill", getStatusColor) // Apply dynamic fill color
        .transition()
        .duration(SMARL_SETTINGS.TRANSITION_SHORT)
        .attr("opacity",1);


        // --- RACE STATUS TEXT ---

        // Function to determine the text content (remains unchanged, but note the lapsLeft logic is a bit unusual)
        const getStatusText = (d) => {
            let lapsLeft = Number(d['lapsLeft']) + 1; 
            let sText = d['status'];
            
            if (lapsLeft <= 0 || sText === 'Finished'){
                return 'FINISHED'
            } 
            if (lapsLeft === 1) {
                return 'FINAL LAP'
            }
            if (sText === 'Green Flag' ) {
                return lapsLeft + " TO GO"
            } 
            if (sText === 'Formation Lap') {
                return "FORMATION"
            }
            // Default to status text (Caution, Pause, etc.) - Uppercase for emphasis
            return sText.toUpperCase();
        }

        statusText = interactive_chart.selectAll(".statusText")
        // FIX: Use a fixed key to ensure D3 updates the existing element, not exit/enter
        .data(data, d => 'single_status_text'); 

        // EXIT
        statusText.exit().transition().attr("x", chartSettings.width * 2).attr("opacity",0).duration(SMARL_SETTINGS.TRANSITION_SHORT).remove();

        // ENTER
        const statusTextEnter = statusText.enter()
        .append('text')
        .attr('class','statusText racerEl')
        .attr('dy',"3px")
        .attr('font-family',"var(--brand-font-header)")
        .attr('font-size','32px')
        .attr('font-weight','bold')
        .attr('text-anchor', 'middle')
        .attr('alignment-baseline', 'middle')
        .attr("x", chartSettings.width/2)
        .attr('y',chartSettings.height/2) 
        .attr("opacity",0);
        
        // MERGE 
        statusTextEnter.merge(statusText)
        .text(getStatusText)
        .attr('fill', getTextColor)
        .transition()
        .duration(SMARL_SETTINGS.TRANSITION_SHORT)
        .attr("opacity",1);
    }

    </script>

    <script> 
        // loads,parses, and calls all chart creation
        var smarl_data  = [] 
        // SOCKET FUNCTIONS
        var socket = io.connect('http://' + document.domain + ':' + location.port);
        socket.on( 'connect', function() {
         
        socket.on( 'raceData', function( data ) {
            // Note: Data is wrapped in an array [data] because D3 expects an iterable,
            // even if it's only one item for this single-status board.
            smarl_data = [data['meta_data']] 
            if (smarl_data == null || smarl_data.length == 0){
                return
            }
          if (smarl_data.length > 0 && !boardCreated){
            initialize(smarl_data)
          } else if(smarl_data.length > 0 && boardCreated){
              updateGraphic(smarl_data)
          }else{
              console.log("No data yet??")
          }
        })})
        function initialize(data){
            createBoard(data);
        }
        function updateGraphic(data){
            reloadGraphic(data);
        }
    
        $(document).ready(function() {
            //var data =[{'id': 1, 'status': "Green Flag", 'lapsLeft': "10"}]
            //initialize(data);
        });
        </script>

{% endblock %}