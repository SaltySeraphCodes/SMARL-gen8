{% extends 'overlay_base.html' %}
{% block title %}
Smarl Status Display
{% endblock %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/stream_brand.css') }}">
<div id="lapDisplay">
</div>
    <script src="{{ url_for('static', filename='src/smarl_utils.js') }}"></script>
    <script>    
    var boardCreated = false;   
    function reloadChart(){
        d3.select("#lapDisplay").selectAll("svg").remove();
        reloadGraphic();
    }

    function reloadGraphic(data){
        drawData(data);
    }
    // Global chart element vars
    // data helpers
    var yScale;
    var xScale;
    var chart_area;
    var interactive_chart;
    var chartSettings;

    // Visible elements
    var racerBG; // The background squares that contain the data
    var posRects;

    var all_elements = []

    function createBoard(data) {
        totalCars = 1 
        // Optimized for a compact display in the corner of a stream
        chartSettings = { width: 250, height: 70, margin: {left: 30, right:30, top: 20, bottom:20}} 
        //Scales
        xScale = d3.scaleLinear()
            .domain([0,(chartSettings.length)])
            .range([0,chartSettings.width]);

        yScale = d3.scaleLinear()
            .domain([0,totalCars])// Total cars racing
            .range([chartSettings.margin.top,chartSettings.height - chartSettings.margin.bottom]); 

        chart_area = d3.select("#lapDisplay").append("svg")
            .attr('width', chartSettings.width)
            .attr('height',chartSettings.height)
        interactive_chart = chart_area.append('g')
        
        var bgRect = interactive_chart.append('rect')
        .attr("x",0)
        .attr('y',0)
        .attr("rx",10)
        .attr('ry',10)
        .attr('width',chartSettings.width)
        .attr('height',0)
        .attr('opacity',0)
        // --- BRANDING: Use brand-main as the base container color ---
        .attr('fill','var(--brand-main)') 
        .transition()
        .attr('height',chartSettings.height)
        .attr("opacity",0.85)
        // --- OPTIMIZATION: Use centralized setting ---
        .duration(SMARL_SETTINGS.TRANSITION_SHORT)
        
        drawData(data)
        boardCreated = true;    

    }
    function drawData(data){
        
        // Function to determine the fill color based on status
        const getStatusColor = (d) => {
            // Checkered Flag/Finished
            if (d['lapsLeft'] === '0' || d['lapsLeft'] === '-1' || d['status'] === 'Finished') {
                return 'var(--status-finished)'; // White/Light
            }
            // Caution/Yellow Flag
            if (d['status'] === 'Caution') {
                return 'var(--status-caution)'; // Yellow/Accent
            }
            // Green Flag/Racing
            if (d['status'] === 'Green Flag') {
                return 'var(--status-racing)'; // Green
            }
            // Formation/Other (Pre-race/Black Flag)
            return 'var(--status-pre-race)'; // Dark/Black/Main background color
        }
        
        // --- STATUS BACKGROUND RECTANGLE ---
        racerBG = interactive_chart.selectAll(".bgRectStatus")
        .data(data, d => d.status); // Bind data using status as the key (only one item, but keeps pattern)
        
        // --- 1. EXIT Selection ---
        racerBG.exit()
        .transition()
        .attr("x", chartSettings.width)
        .attr("opacity",0)
        // --- OPTIMIZATION: Use centralized setting ---
        .duration(SMARL_SETTINGS.TRANSITION_SHORT)
        .remove();

        // --- 2. ENTER Selection ---
        const racerBGEnter = racerBG.enter()
        .append("rect")
        .attr("class","bgRectStatus racerEl")
        .attr('rx',10)
        .attr('ry',10)
        .attr("width",chartSettings.width-10)
        .attr("height",chartSettings.height - 10)
        .attr('stroke','var(--brand-dark)')
        // Initial state: Start off screen bottom
        .attr("x",5) 
        .attr("y",chartSettings.height) 
        .attr("opacity",0);

        // --- 3. MERGE Selection (Apply common attributes and transition) ---
        racerBGEnter.merge(racerBG)
        .attr("fill", getStatusColor) // Apply dynamic fill color
        .transition()
        // --- OPTIMIZATION: Use centralized setting ---
        .duration(SMARL_SETTINGS.TRANSITION_SHORT)
        .attr("x",5)
        .attr("y",5)
        .attr("opacity",1);

        all_elements.push(racerBGEnter.merge(racerBG));


        // --- RACE STATUS TEXT ---

        // Function to determine the text content
        const getStatusText = (d) => {
            // Note: lapsLeft is a string, cast to Number before calculation
            let lapsLeft = Number(d['lapsLeft']) + 1; 
            let sText = d['status'];
            
            if (lapsLeft <= 0 || sText === 'Finished'){
                return 'Finished'
            } 
            if (lapsLeft === 1) {
                return 'Final Lap'
            }
            if (sText === 'Green Flag' ) {
                return lapsLeft + " To Go"
            } 
            if (sText === 'Formation Lap') {
                return "Formation"
            }
            // Default to status text (Caution, Pause, etc.)
            return sText;
        }

        // Function to determine the text color (contrast)
        const getTextColor = (d) => {
            const statusColor = getStatusColor(d);
            // If background is Finished (light color) or Caution (light color), use dark text for contrast
            if (statusColor === 'var(--status-finished)' || statusColor === 'var(--status-caution)'){
                return 'var(--brand-dark)'
            }
            // Otherwise use the inverted (usually light) brand text color
            return 'var(--brand-text)'
        }


        statusText = interactive_chart.selectAll(".statusText")
        .data(data, d => d.status); // Bind data using status as the key (only one item)

        // --- 1. EXIT Selection ---
        statusText.exit()
        .transition()
        .attr("x", chartSettings.width * 2)
        .attr("opacity",0)
        // --- OPTIMIZATION: Use centralized setting ---
        .duration(SMARL_SETTINGS.TRANSITION_SHORT)
        .remove();

        // --- 2. ENTER Selection ---
        const statusTextEnter = statusText.enter()
        .append('text')
        .attr('class','statusText racerEl')
        .attr('dy',"0.35em")
        .attr('font-family',"var(--brand-font-header)")
        .attr('font-size','32px')
        .attr('font-weight','bold')
        .attr('text-anchor', 'middle')
        .attr('alignment-baseline', 'middle')
        // Initial state: Start off screen bottom
        .attr("x", chartSettings.width/2)
        .attr('y',chartSettings.height + 50) 
        .attr("opacity",0);
        
        // --- 3. MERGE Selection (Apply common attributes and transition) ---
        statusTextEnter.merge(statusText)
        .text(getStatusText)
        .attr('fill', getTextColor)
        .transition()
        // --- OPTIMIZATION: Use centralized setting ---
        .duration(SMARL_SETTINGS.TRANSITION_SHORT)
        .attr("x",  chartSettings.width/2)
        .attr('y',chartSettings.height/2) // Center the text vertically
        .attr("opacity",1);

        all_elements.push(statusTextEnter.merge(statusText));
    }

    </script>
    <script> 
        // loads,parses, and calls all chart creation
        var smarl_data  = [] 
        // SOCKET FUNCTIONS
        var socket = io.connect('http://' + document.domain + ':' + location.port);
        socket.on( 'connect', function() {
         
        socket.on( 'raceData', function( data ) {
            // Note: Data is wrapped in an array [data] because D3 expects an iterable,
            // even if it's only one item for this single-status board.
            smarl_data = [data['meta_data']] 
          if (smarl_data.length > 0 && !boardCreated){
            initialize(smarl_data)
          } else if(smarl_data.length > 0 && boardCreated){
              updateGraphic(smarl_data)
          }else{
              console.log("No data yet??")
          }
        })})
        function initialize(data){
            //updateInterval = setInterval(updateGraphic, 1000);
            createBoard(data);
        }
        function updateGraphic(data){
            // Do whatever too
            reloadGraphic(data);
        }
    
        $(document).ready(function() {
            //var data =[{'id': 1, 'status': "Green Flag", 'lapsLeft': "10"}]
            //initialize(data);
        });
        </script>

{% endblock %}